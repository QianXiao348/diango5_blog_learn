{# article/blog_detail.html #}
{% extends 'base.html' %}
{% load static %} {# 确保加载 static 标签 #}

{% block title %}博客详情页{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'highlight/styles/default.min.css' %}">
<script src="{% static 'highlight/highlight.min.js' %}"></script>
{# 确保 Font Awesome 已经通过 base.html 引入。如果没引入，可以在这里再引入一次 #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0MDxM+h/f/b/Kx0zBf9Q2+Xv8Xl5P9+7s+228/w/p+XyR/k6+D/S7x8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    /* 评论项的基础样式 - 保持不变 */
    .comment-item {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }
    /* 评论缩进 (在 base.css 或这里定义) - 保持不变 */
    /* 注意：这里是硬编码了 level 样式，_comment.html 会使用 comment.display_level */
    .comment-level-0 { margin-left: 0px; border-left: 3px solid #007bff; padding-left: 17px; }
    .comment-level-1 { margin-left: 20px; border-left: 3px solid #28a745; padding-left: 17px; }
    .comment-level-2 { margin-left: 40px; border-left: 3px solid #ffc107; padding-left: 17px; }
    .comment-level-3 { margin-left: 60px; border-left: 3px solid #dc3545; padding-left: 17px; }
    /* 回复表单的默认隐藏 - 这条可以保留，因为它可能在 _comment.html 中定义 */
    .reply-form {
        margin-top: 5px;
        margin-bottom: 10px;
        display: none; /* 关键：默认隐藏 */
    }
    /* 头像样式 - 保持不变 */
    .user-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
    }
    /* 作者的样式 - 保持不变 */
    .author-name {
        font-weight: 600;
        color: rgba(255, 174, 0, 0.98);
        font-size: 1.1em;
        border-bottom: 1px dotted #ffffff;
        padding: 2px 4px;
        border-radius: 3px;
    }
    /* 博客内容中的图片样式 (如果未在 base.css 全局控制，这里可以加上) - 保持不变 */
    .blog-content img,
    .w-e-text-container img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    /* 为统计信息添加一些样式，使其在同一行 */
    .blog-stats {
        display: flex;
        align-items: center;
        gap: 15px; /* 各个统计项之间的间距 */
        margin-top: 10px; /* 与上方博客元信息隔开 */
        margin-bottom: 20px; /* 与下方内容和评论区隔开 */
        flex-wrap: wrap; /* 小屏幕下允许换行 */
        padding: 10px 0; /* 内部留白 */
        border-top: 1px solid #eee; /* 添加上边框 */
        border-bottom: 1px solid #eee; /* 添加下边框 */
        background-color: #f8f9fa; /* 轻微背景色 */
        border-radius: 5px; /* 圆角 */
    }
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
        color: #555;
    }
    .stat-item .fas, .stat-item .far {
        font-size: 1.1em;
        color: #007bff; /* 图标颜色 */
    }
    .like-button-group {
        display: flex;
        align-items: center;
        gap: 8px; /* 按钮与数量之间的间距 */
        margin-left: auto; /* 将点赞组推到右边 */
    }
    /* 调整点赞图标颜色 */
    .btn-outline-primary .far.fa-heart,
    .btn-outline-primary .fas.fa-heart {
        color: #007bff; /* 默认未点赞的爱心颜色 */
    }
    .btn-primary .fas.fa-heart {
        color: white; /* 已点赞的爱心颜色 */
    }
    .btn-outline-primary:hover .far.fa-heart {
        color: white; /* 悬停时爱心变为白色 */
    }
</style>
{% endblock %}

{% block main %}
<h2>{{ blog.title }}</h2>
<hr>
<div class="mt-2">
    <img src="{% if blog.author.profile.avatar %}{{ blog.author.profile.avatar.url }}{% else %}{% static 'image/21.png' %}{% endif %}"
        class="rounded-circle" width="30" alt="">
    <span class="ms-2 author-name">{{ blog.author.username }}</span>
    <span class="ms-2">发布时间：</span>
    <span class="font-monospace">{{ blog.pub_time|date:'Y-m-d H:i' }}</span>
    <span class="ms-2">所属标签：{{ blog.category.name }}</span>
</div>
<hr>
<div class="blog-content">
    {{ blog.content|safe }}
</div>
<hr>

{# 浏览量、点赞量和点赞按钮 #}
<div class="blog-stats">
    <span class="stat-item">
        <i class="fas fa-eye"></i> 浏览量: <span id="view-count-display">{{ blog.view_count }}</span>
    </span>
<span class="stat-item">
    <i class="fas fa-comment-dots"></i> 评论数: {{ blog.comment_count | default:0 }} {# 这里已经正确使用 blog.comment_count #}
</span>
    <div class="like-button-group">
        <span class="stat-item">
            <i class="fas fa-thumbs-up"></i> 点赞: <span id="like-count-display">{{ blog.like_count }}</span>
        </span>

        {% if request.user.is_authenticated %}
            <button id="toggle-like-btn" data-blog-id="{{ blog.id }}"
                    class="btn btn-sm {% if is_liked %}btn-primary{% else %}btn-outline-primary{% endif %}">
                {# 根据 is_liked 变量显示不同的图标和文本 #}
                {% if is_liked %}
                    <i class="fas fa-heart"></i> 已点赞
                {% else %}
                    <i class="far fa-heart"></i> 点赞
                {% endif %}
            </button>
        {% else %}
            {# 未登录用户点击跳转到登录页，并带上 next 参数，登录后可返回当前页面 #}
            <a href="{% url 'qxauth:login' %}?next={{ request.path }}" class="btn btn-sm btn-outline-primary">
                <i class="far fa-heart"></i> 登录点赞
            </a>
        {% endif %}
    </div>
</div>

{% if request.user.is_authenticated %}
    {% if request.user == blog.author or request.user.is_superuser %}
        <div class="mt-2">
            <a href="{% url 'blog:edit_blog' blog_id=blog.id %}" class="btn btn-warning">编辑博客</a>
            <a href="{% url 'blog:delete_blog' blog_id=blog.id %}" class="btn btn-danger ms-2">删除博客</a>
        </div>
    {% endif %}
{% endif %}

<div class="mt-4">
    {# 核心修改：评论总数显示，使用 blog.comment_count #}
    <h3>评论 ({{ blog.comment_count | default:0 }} )：</h3>
    <div id="comment-error-message" class="alert alert-danger" style="display:none;"></div> {# 错误提示区域 #}
    <form id="comment-form" method="post" action="{% url 'blog:pub_comment' blog.id %}">
        {% csrf_token %}
        <div class="mb-3">
            {{ comment_form.content }}
        </div>
        {# 隐藏的父评论和回复用户ID字段，用于二级回复 #}
        <input type="hidden" name="parent_comment_id" id="parent-comment-id" value="">
        <input type="hidden" name="reply_to_user_id" id="reply-to-user-id" value="">

        <div class="text-end mt-2">
            {# 根据用户登录状态显示按钮 #}
            {% if request.user.is_authenticated %}
                <button type="button" id="submit-comment-btn" class="btn btn-primary">发表评论</button>
            {% else %}
                <button type="button" class="btn btn-primary" onclick="window.location.href = '{% url 'qxauth:login' %}?next={{ request.path }}'">登录后评论</button>
            {% endif %}
        </div>
    </form>
</div>

<div class="mt-2">
    <ul class="list-group list-group-flush">
        {% for comment in comments %}
        {# 传递 comment.display_level 到 _comment.html #}
        {% include 'article/_comment.html' with comment=comment comment_form=comment_form %}
        {% empty %} {# 如果没有评论，显示此消息 #}
            <li class="list-group-item text-center text-muted">目前还没有评论。</li>
        {% endfor %}
    </ul>
</div>

{# 评论分页导航 #}
<nav aria-label="评论分页" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if comments.has_previous %}
            <li class="page-item">
                {# 确保分页链接保持现有的查询参数，包括 notification_id #}
                <a class="page-link" href="?comment_page={{ comments.previous_page_number }}{% if request.GET.notification_id %}&notification_id={{ request.GET.notification_id }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link" aria-hidden="true">&laquo;</span>
            </li>
        {% endif %}

        {% for page_num in comments.paginator.page_range %}
            {% if comments.number == page_num %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
            {% else %}
                {# 确保分页链接保持现有的查询参数，包括 notification_id #}
                <li class="page-item"><a class="page-link" href="?comment_page={{ page_num }}{% if request.GET.notification_id %}&notification_id={{ request.GET.notification_id }}{% endif %}">{{ page_num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if comments.has_next %}
            <li class="page-item">
                {# 确保分页链接保持现有的查询参数，包括 notification_id #}
                <a class="page-link" href="?comment_page={{ comments.next_page_number }}{% if request.GET.notification_id %}&notification_id={{ request.GET.notification_id }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link" aria-hidden="true">&raquo;</span>
            </li>
        {% endif %}
    </ul>
</nav>


<script src="{% static 'jquery/jquery-3.7.1.min.js' %}"></script>
<script>
    $(document).ready(function() {
        hljs.highlightAll(); // 代码高亮，确保在DOM加载完成后调用

        const blogId = {{ blog.id }};
        const commentForm = $("#comment-form");
        const submitCommentBtn = $("#submit-comment-btn"); // 获取提交评论按钮
        const commentContentInput = $("#id_content");
        const parentCommentIdInput = $("#parent-comment-id");
        const replyToUserIdInput = $("#reply-to-user-id");
        const commentErrorMessage = $("#comment-error-message");

        // ===============================================
        // 点赞功能相关的JS (保持不变)
        // ===============================================
        const toggleLikeBtn = $('#toggle-like-btn');
        const likeCountDisplay = $('#like-count-display');

        // CSRF Token 获取函数 (确保其在全局或可访问范围内)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        if (toggleLikeBtn.length) { // 确保点赞按钮存在（用户已登录）
            toggleLikeBtn.on('click', function() {
                $.ajax({
                    url: `{% url 'blog:toggle_like' blog_id=blog.id %}`,
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    success: function(response) {
                        if (response.code === 200) {
                            // 更新点赞按钮样式和文本
                            if (response.is_liked) { // is_liked 字段由后端返回
                                toggleLikeBtn.removeClass('btn-outline-primary').addClass('btn-primary');
                                toggleLikeBtn.html('<i class="fas fa-heart"></i> 已点赞');
                            } else {
                                toggleLikeBtn.removeClass('btn-primary').addClass('btn-outline-primary');
                                toggleLikeBtn.html('<i class="far fa-heart"></i> 点赞');
                            }
                            // 更新点赞数量显示
                            likeCountDisplay.text(response.like_count);
                        } else {
                            alert(response.msg); // 显示错误信息
                            console.error("点赞操作失败:", response.msg);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        let errorMsg = "网络或服务器错误，点赞失败。";
                        if (jqXHR.responseJSON && jqXHR.responseJSON.msg) {
                            errorMsg = jqXHR.responseJSON.msg;
                        } else if (jqXHR.responseText) {
                            errorMsg = "服务器返回错误: " + jqXHR.responseText.substring(0, 100) + "...";
                        }
                        alert(errorMsg);
                        console.error("点赞 AJAX 错误:", jqXHR.status, textStatus, errorThrown, jqXHR.responseText);
                    }
                });
            });
        }
        // ===============================================


        // ===============================================
        // 处理回复按钮点击事件，滚动到主评论表单
        // ===============================================
        $(document).on('click', '.reply-button', function() {
            // 首先判断用户是否已登录，未登录则提示并阻止后续操作
            {% if not request.user.is_authenticated %}
                alert('请先登录才能回复！');
                window.location.href = '{% url 'qxauth:login' %}?next={{ request.path }}';
                return; // 阻止后续JS执行
            {% endif %}

            const parentId = $(this).data('comment-id');
            const authorName = $(this).data('author-name');
            const authorId = $(this).data('author-id');

            // 设置主评论表单的隐藏字段
            parentCommentIdInput.val(parentId);
            replyToUserIdInput.val(authorId);
            // 存储 authorName，用于后续清除状态的判断
            replyToUserIdInput.data('author-name', authorName);

            // 清空评论输入框（如果需要），然后填充回复文本
            commentContentInput.val(''); // 确保清空旧内容
            commentContentInput.val(`回复 @${authorName} : `).focus(); // 填充并聚焦

            // 滚动到主评论表单
            // 瞬间滚动
            $('html, body').scrollTop(commentForm.offset().top - 80);

            // 确保隐藏所有其他回复表单（如果它们是通过 _comment.html 渲染出来的）
            // 如果你已经从 _comment.html 中移除了这些内联表单，这一行可以移除
            $('.reply-form').hide();
        });

        // ===============================================
        // 清除回复状态的逻辑
        // ===============================================
        commentContentInput.on('input', function() {
            const currentVal = $(this).val();
            const prefixAuthorName = replyToUserIdInput.data('author-name');
            const prefix = prefixAuthorName ? `回复 @${prefixAuthorName} : ` : '';

            if (currentVal === '' || (prefix && !currentVal.startsWith(prefix))) {
                 // 如果完全清空，或者不再是回复模式，则清除
                parentCommentIdInput.val('');
                replyToUserIdInput.val('');
                replyToUserIdInput.removeData('author-name'); // 清除存储的作者名
            } else if (parentCommentIdInput.val() && !currentVal.startsWith(prefix)) {
                // 如果是回复状态，但文本内容不再以精确前缀开头（用户可能删改了）
                parentCommentIdInput.val('');
                replyToUserIdInput.val('');
                replyToUserIdInput.removeData('author-name');
            }
        });

        $(document).on('click', function(e) {
            // 检查点击的不是评论表单内部，也不是回复按钮本身
            if (!$(e.target).closest('#comment-form').length && !$(e.target).closest('.reply-button').length) {
                // 如果当前评论框内容是回复形式，且用户点击了外部，清空回复状态
                if (commentContentInput.val().startsWith('回复 @')) {
                    commentContentInput.val(''); // 清空回复内容
                }
                parentCommentIdInput.val('');
                replyToUserIdInput.val('');
                replyToUserIdInput.removeData('author-name');
            }
        });
        // ===============================================


        // ===============================================
        // 提交评论按钮点击事件
        // ===============================================
        // 这里的 submitCommentBtn 只有在用户登录时才存在，无需额外的 if (submitCommentBtn.length) 判断
        // 因为如果未登录，HTML 渲染的是另一个按钮。
        // 但为了代码健壮性，我们可以保留它，或者让 JavaScript 更简单。
        if ($("#submit-comment-btn").length) { // 检查按钮是否存在
            $("#submit-comment-btn").on('click', function(event) {
                event.preventDefault();

                // 在这里再次检查用户登录状态，以防万一
                {% if not request.user.is_authenticated %}
                    alert('请先登录才能发表评论！');
                    window.location.href = '{% url 'qxauth:login' %}?next={{ request.path }}';
                    return; // 阻止后续 AJAX 提交
                {% endif %}

                const content = commentContentInput.val();
                const parent_comment_id = parentCommentIdInput.val();
                const reply_to_user_id = replyToUserIdInput.val();

                if (!content.trim()) {
                    commentErrorMessage.text("评论内容不能为空！").show();
                    return;
                } else {
                    commentErrorMessage.hide();
                }

                const csrfToken = getCookie('csrftoken'); // 使用 getCookie 获取 CSRF token
                const postData = {
                    content: content,
                    blog_id: blogId,
                    parent_comment_id: parent_comment_id,
                    reply_to_user_id: reply_to_user_id
                };

                $.ajax({
                    url: commentForm.attr('action'),
                    method: 'POST',
                    data: postData,
                    headers: { 'X-CSRFToken': csrfToken },
                    success: function(response) {
                        if (response.code === 200) {
                            commentContentInput.val('');
                            parentCommentIdInput.val('');
                            replyToUserIdInput.val('');
                            replyToUserIdInput.removeData('author-name'); // 提交成功后清除
                            commentErrorMessage.hide();
                            window.location.reload();
                        } else {
                            commentErrorMessage.text(response.msg).show();
                            console.error("评论失败:", response.msg);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        let errorMsg = "网络或服务器错误，请重试。";
                        // 403 Forbidden 或其他认证失败
                        if (jqXHR.status === 403 || jqXHR.status === 401) {
                            alert('会话已过期或未登录，请重新登录！');
                            window.location.href = '{% url 'qxauth:login' %}?next={{ request.path }}';
                            return;
                        }

                        if (jqXHR.responseJSON && jqXHR.responseJSON.msg) {
                            errorMsg = jqXHR.responseJSON.msg;
                        } else if (jqXHR.responseText) {
                            errorMsg = "服务器返回错误: " + jqXHR.responseText.substring(0, 100) + "...";
                        }
                        commentErrorMessage.text(errorMsg).show();
                        console.error("评论 AJAX 错误:", jqXHR.status, textStatus, errorThrown, jqXHR.responseText);
                    }
                });
            });
        }

        // ===============================================
        // 删除评论按钮 (保持不变)
        // ===============================================
        $(document).on('click', '.delete-comment-btn', function() {
            if (!confirm("确定要删除这条评论吗？")) {
                return;
            }
            const commentId = $(this).data('comment-id');
            const csrfToken = getCookie('csrftoken');

            $.ajax({
                url: `/blog/comment/delete/${commentId}/`,
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                success: function(response) {
                    if (response.code === 200) {
                        window.location.reload();
                    } else {
                        commentErrorMessage.text(response.msg).show();
                        console.error("删除失败:", response.msg);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // 403 Forbidden 或其他认证失败
                    if (jqXHR.status === 403 || jqXHR.status === 401) {
                        alert('会话已过期或未登录，请重新登录！');
                        window.location.href = '{% url 'qxauth:login' %}?next={{ request.path }}';
                        return;
                    }

                    let errorMsg = "网络或服务器错误，请重试。";
                    if (jqXHR.responseJSON && jqXHR.responseJSON.msg) {
                        errorMsg = jqXHR.responseJSON.msg; 
                    } else if (jqXHR.responseText) {
                        errorMsg = "服务器返回错误: " + jqXHR.responseText.substring(0, 100) + "..."; 
                    }
                    commentErrorMessage.text(errorMsg).show();
                    console.error("删除评论 AJAX 错误:", jqXHR.status, textStatus, errorThrown, jqXHR.responseText);
                }
            });
        });
    });
</script>
{% endblock %}